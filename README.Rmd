---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# oxcgrt: An Interface to the Oxford COVID-19 Government Response Tracker API

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R build status](https://github.com/como-ph/oxcgrt/workflows/R-CMD-check/badge.svg)](https://github.com/como-ph/oxcgrt/actions)
![test-coverage](https://github.com/como-ph/oxcgrt/workflows/test-coverage/badge.svg)
[![Codecov test coverage](https://codecov.io/gh/como-ph/oxcgrt/branch/master/graph/badge.svg)](https://codecov.io/gh/como-ph/oxcgrt?branch=master)
[![CodeFactor](https://www.codefactor.io/repository/github/como-ph/oxcgrt/badge)](https://www.codefactor.io/repository/github/como-ph/oxcgrt)
<!-- badges: end -->

The [Oxford COVID-19 Government Response Tracker (OxCGRT)](https://www.bsg.ox.ac.uk/covidtracker) tracks and compares worldwide government responses to the COVID-19 pandemic rigorously and consistently. [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) makes available systematic information in a consistent way, aiding those who require information have access to it efficiently for their purposes. This package facilitates access to the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) data via its API for R users. This package also includes functions to calculate the various [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) indices.

## Installation

<!---
You can install the released version of oxcgrt from [CRAN](https://CRAN.R-project.org) with:

```{r, echo = TRUE, eval = FALSE}
install.packages("oxcgrt")
```

And the development version from [GitHub](https://github.com/) with:
--->

`oxcgrt` is not yet available on [CRAN](https://cran.r-project.org).

The development version of `oxcgrt` can be installed via [GitHub](https://github.com/como-ph/oxcgrt):

```{r, echo = TRUE, eval = FALSE}
if(!require(remotes)) install.packages("remotes")
remotes::install_github("como-ph/oxcgrt")
```

## Usage

The `oxcgrt` package includes two types of functions. First are functions that retrieve data via [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker)'s API, and second are functions that calculate [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker)'s various indices.

### Retrieve data

The *retrieve data* functions are based on the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker)'s JSON API described [here](https://covidtracker.bsg.ox.ac.uk/about-api). Two API endpoints are provided: 1) endpoint for JSON providing data for stringency index by country over time; and, 2) endpoint for JSON providing data on policy actions and stringency index for a specific country on a specific day.

#### Stringency index by country over time

The first API endpoint provides JSON for all countries included in the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) over a specified period of time:

<br/>

`https://covidtrackerapi.bsg.ox.ac.uk/api/v2/stringency/date-range/{start-date}/{end-date}`

<br/>

where `start-date` and `end-date` are the starting date and ending date (both in `YYYY-MM-DD` format) respectively from which to retrieve data.

The `oxcgrt` package provides a function named `get_json_time` to interface with the API and retrieve the specified JSON and a function named `get_data_time` to extract the data from the specified JSON into an [R](https://cran.r-project.org) `tibble` object. These two functions have been designed such that they can be piped from one to the other. Hence to retrieve stringency index data for all countries from 1 June 2020 to current date, the following code can be used:

```{r usage1, echo = TRUE, eval = FALSE}
library(oxcgrt)
library(magrittr)

get_json_time(from = "2020-06-01") %>% get_data_time()
```

This produces the following output:

```{r usage1a, echo = FALSE, eval = TRUE}
library(oxcgrt)
library(magrittr)

get_json_time(from = "2020-06-01") %>% get_data_time()
```

Important to note that in `get_json_time`, only the starting date (using the `from` argument) is specified to the desired 1 June 2020 in `YYYY-MM-DD` format. This is because by default the `to` argument (for the ending date) is set to the current date using a call to the `Sys.Date()` function. By default, the `from` argument is set to 2 January 2020 (2020-01-02) which is the earliest available data point for the stringency index. Therefore, to retrieve data on stringency index for all countries for all available time points up to current, the following commands can be issued:

```{r usage2, echo = TRUE, eval = FALSE}
get_json_time() %>% get_data_time()
```

which produces the following output:

```{r usage2a, echo = FALSE, eval = TRUE}
get_json_time() %>% get_data_time()
```

#### Policy actions and stringency index for specific country on a specific day

The second API endpoint provides JSON for a specific country included in the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) for a specified day:

<br/>

`https://covidtrackerapi.bsg.ox.ac.uk/api/v2/stringency/actions/{country-code}/{date}`

<br/>

where `country-code` is the ISO 3166-1 alpha-3 country code for the required country to get data for and `date` is the date (in `YYYY-MM-DD` format) on which to retrieve data.

The `oxcgrt` package provides a function named `get_json_actions` to interface with the API and retrieve the specified JSON and a function named `get_data` to extract the data from the specified JSON into a named `list` [R](https://cran.r-project.org) object. These two functions have been designed such that they can be piped from one to the other. Hence to retrieve policy actions and stringency index data for Afghanistan for 1 June 2020, the following code can be used:

```{r usage3, echo = TRUE, eval = FALSE}
get_json_actions(ccode = "AFG", from = NULL, to = "2020-06-01") %>% get_data()
```

which produces the following output:

```{r usage3a, echo = FALSE, eval = TRUE}
get_json_actions(ccode = "AFG", from = NULL, to = "2020-06-01") %>% get_data()
```

Important to note that the output is a named `list` object containing a `tibble` of **policy actions** data and a `tibble` of **stringency index** data for the specified country and the specified date.

#### Policy actions for specific country or countries on a specific day or days

It is also possible to retrieve just policy actions data for a specific country or for multiple countries on a specific day or multiple days. To retrieve policy actions data for Afghanistan for 1 June 2020, the following code can be used:

```{r usage4, echo = TRUE, eval = FALSE}
get_json_actions(ccode = "AFG", from = NULL, to = "2020-06-01") %>% get_data_action()
```

This results in:

```{r usage4a, echo = FALSE, eval = TRUE}
get_json_actions(ccode = "AFG", from = NULL, to = "2020-06-01") %>% get_data_action()
```

Important to note here that the output is a tibble of just the policy actions and two additional columns have been added to the dataset - `date_value` and `country_code` - to identify the data as coming from a specific date and for a specific country.

To retrieve policy actions data for multiple countries on multiple days, the `get_data_actions` functions can be used as shown below:

```{r usage5, echo = TRUE, eval = FALSE}
get_json_actions(ccode = c("AFG", "Philippines"), from = "2020-10-25", to = "2020-10-31") %>% get_data_actions()
```

This results in:

```{r usage5a, echo = FALSE, eval = TRUE}
get_json_actions(ccode = c("AFG", "Philippines"), from = "2020-10-25", to = "2020-10-31") %>% get_data_actions()
```

Important to note here that the output is a tibble of just the policy actions and two additional columns have been added to the dataset - `date_value` and `country_code` - to identify the data as coming from a specific date and for a specific country.

### Calculate OxCGRT indices

The *calculate* functions are based on the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker)'s methodology described [here](https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/index_methodology.md). There are two sets of calculate functions included in `oxcgrt`. The first calculates the [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) **sub-indices** described in the table below:

```{r usage6, echo = FALSE, eval = TRUE}
knitr::kable(x = codebook[c(1, 3, 5, 7, 9, 11, 13, 15:16, 18:21, 23:28), ])
```

The second calculates the four [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) **indices** which are composed of various combinations of the indicators described in the table above. These combinations are described in the table below:

```{r usage7, echo = FALSE, eval = TRUE}
library(rvest)
library(xml2)

x <- xml2::read_html("https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/index_methodology.md") %>%
  rvest::xml_nodes(css = ".markdown-body table") %>%
  rvest::html_table()

x <- data.frame(t(x[[1]]))

x <- data.frame(`Index name` = row.names(x), x)

tab <- x[3:nrow(x), ]
names(tab) <- x[1, ]
row.names(tab) <- 1:nrow(tab)

tab <- tab %>%
  dplyr::mutate(`Government response index` = ifelse(`Government response index` == "'x'", "x", `Government response index`),
                `Containment and health index` = ifelse(`Containment and health index` == "'x'", "x", `Containment and health index`))

tab <- codebook[c(1, 3, 5, 7, 9, 11, 13, 15:16, 18:21, 23:28), c("ID", "Name")] %>%
  dplyr::mutate(Name = stringr::str_remove_all(string = Name, pattern = "[A-Z]{1}[0-9]{1}\\_")) %>%
  merge(tab, by.x = "ID", by.y = "Index name")

knitr::kable(x = tab[ , 1:6])
```

#### Calculating OxCGRT sub-indices

The [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) subindices can be calculated using the `calculate_subindex` and `calculate_subindices` functions. To calculate a specific sub-index, the following code is used:

```{r usage8, echo = TRUE, eval = FALSE}
## Given the C1 data in indicatorData, calculate C1 sub-index
calculate_subindex(indicator_code = indicatorData[1, "indicator"], 
                   value = indicatorData[1, "value"], 
                   flag_value = indicatorData[1, "flag_value"])
```

This gives a C1 index value of:

```{r usage8a, echo = FALSE, eval = TRUE}
## Given the C1 data in indicatorData, calculate C1 sub-index
calculate_subindex(indicator_code = indicatorData[1, "indicator"], 
                   value = indicatorData[1, "value"], 
                   flag_value = indicatorData[1, "flag_value"])
```

To calculate all [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) subindices, the following code is used:

```{r usage9, echo = TRUE, eval = FALSE}
## Given the indicatorData dataset, calculate all sub-indices
indicatorData %>%
  calculate_subindices(indicator_code = "indicator", 
                       value = "value", 
                       flag_value = "flag_value",
                       add = TRUE)
```

This results in the following output:

```{r usage9a, echo = FALSE, eval = TRUE}
## Given the indicatorData dataset, calculate all sub-indices
indicatorData %>%
  calculate_subindices(indicator_code = "indicator", 
                       value = "value", 
                       flag_value = "flag_value",
                       add = TRUE)
```

It can be noted that the results of the calculations are added to the input data.frame under the column name `score.1`. Comparing this with the value in the column named `score` that is included in the `indicatorData` dataset, the results are the same.

#### Calculating OxCGRT indices

The [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) indices can be calculated using the `calculate_index` and `calculate_indices` functions. To calculate a specific sub-index, the following code can be used:

```{r usage10, echo = TRUE, eval = FALSE}
indicatorData %>%
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_index(codes = c(paste("C", 1:8, sep = ""),
                            paste("E", 1:2, sep = ""),
                            paste("H", 1:3, sep = ""),
                            "H6"), 
                  tolerance = 1)
```

This code calculates the `government response index` which is:

```{r usage10a, echo = FALSE, eval = TRUE}
indicatorData %>%
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_index(codes = c(paste("C", 1:8, sep = ""),
                            paste("E", 1:2, sep = ""),
                            paste("H", 1:3, sep = ""),
                            "H6"), 
                  tolerance = 1)
```

The same result can be reached by using the specialised function `calculate_gov_response` as follows:

```{r usage11, echo = TRUE, eval = FALSE}
indicatorData %>% 
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_gov_response()
```

which results in the same value as the previous code:

```{r usage11a, echo = FALSE, eval = TRUE}
indicatorData %>% 
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_gov_response()
```

To calculate all four [OxCGRT](https://www.bsg.ox.ac.uk/covidtracker) indices, the following code can be implemented:

```{r usage12, echo = TRUE, eval = FALSE}
indicatorData %>% 
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_indices()
```

which outputs the following results:

```{r usage12a, echo = FALSE, eval = TRUE}
indicatorData %>% 
  calculate_subindices(indicator_code = "indicator",
                       value = "value",
                       flag_value = "flag_value",
                       add = FALSE) %>%
  calculate_indices()
```
